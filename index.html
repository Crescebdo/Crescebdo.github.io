<!DOCTYPE HTML>
<html>

<head>
    <style>
        body {
            font-family: "Arial";
        }

        h1 {
            text-align: center;
            margin-top: 30px;
            margin-left: auto;
            margin-right: auto;
        }

        #upload {
            text-align-last: center;
            margin-top: 30px;
            margin-left: auto;
            margin-right: auto;
        }

        #paint {
            text-align: center;
            margin-top: 30px;
            margin-left: auto;
            margin-right: auto;
        }

        #myCanvas {
            border: 3px solid grey;
        }

        #predicted {
            text-align: center;
            margin-top: 30px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.5.2/dist/tf.min.js"></script>
    <h1>IZE Image Recognition (alpha)</h1>
    <div id="upload">
        <input type="file" accept="image/*" id="file" onchange="loadFile(event)">
        <p>You can paste the image (Ctrl+V) too.</p>
    </div>
    <div id="paint">
        <canvas id="myCanvas"></canvas>
    </div>
    <div id="predicted">
        Recognized Plant
        <div id="number"></div>
        <div id="best"></div>
    </div>
    <script>
        var canvas = document.getElementById('myCanvas'),
            context = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // Upload file handler
        var loadFile = function (event) {
            base_image = new Image();
            base_image.src = URL.createObjectURL(event.target.files[0]);
            base_image.onload = function () {
                drawImageToCanvas(context, base_image);
                process(context);
            }
        };

        // Draw original image to canvas
        var drawImageToCanvas = function (context, image) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            scale = base_image.width / 800.0
            scaled_height = Math.trunc(base_image.height / scale);
            if (scaled_height <= 600) {
                context.drawImage(base_image, 0, 0, base_image.width, base_image.height);
            } else {
                cutoff_height = base_image.height - scale * 600;
                context.drawImage(base_image, 0, cutoff_height, base_image.width, base_image.height - cutoff_height, 0, 0, canvas.width, canvas.height);
            }
        }

        // Draw additional lines to canvas
        var drawLinesToCanvas = function (ctx) {
            ctx.strokeStyle = '#ff0000';
            ctx.strokeRect(40, 70, 400, 500);
            ctx.beginPath();
            for (i = 1; i <= 4; i++) {
                ctx.moveTo(40, 70 + i * 100);
                ctx.lineTo(440, 70 + i * 100);
                ctx.moveTo(40 + i * 80, 70);
                ctx.lineTo(40 + i * 80, 570);
            }
            ctx.stroke();
        }

        // Process image data and draw additional lines to canvas
        var process = function (context) {
            data = context.getImageData(0, 0, canvas.width, canvas.height).data;
            drawLinesToCanvas(context);
            // for (i = 0; i < 5; i++) {
            //     for (j = 0; j < 5; j++) {
            //         var rgbArray = []
            //         for (var i = 0; i < data.length; i += 4) {
            //             rgbArray.push([data[i], data[i + 1], data[i + 2]])
            //         }
            //     }
            // }

            // predict(rgbArray);
        }
        tf.loadLayersModel('model/model.json').then(function (model) {
            window.model = model;
        });
        const plants = ["Empty", "Peashooter", "Sunflower", "Wall-nut", "Potato Mine", "Snow Pea", "Chomper", "Repeater", "Puff-shroom", "Fume-shroom", "Scaredy-shroom", "Squash", "Threepeater", "Spikeweed", "Torchwood", "Split Pea", "Starfruit", "Magnet-shroom", "Kernel-pult", "Umbrella Leaf"];
        var predict = function (input) {
            if (window.model) {
                window.model.predict([tf.tensor(input).reshape([1, 100, 80, 3])]).array().then(function (scores) {
                    scores = scores[0]
                    predicted = scores.indexOf(Math.max(...scores));
                    $('#best').html(plants[predicted]);
                });
            } else {
                // The model takes a bit to load, if we are too fast, wait
                setTimeout(function () { predict(input) }, 50);
            }
        }

        // Clipboard Function
        var CLIPBOARD = new CLIPBOARD_CLASS("myCanvas");

        /**
         * image pasting into canvas
         * 
         * @param {string} canvas_id - canvas id
         */
        function CLIPBOARD_CLASS(canvas_id) {
            var _self = this;
            var ctx = document.getElementById(canvas_id).getContext("2d");

            //handlers
            document.addEventListener('paste', function (e) { _self.paste_auto(e); }, false);

            //on paste
            this.paste_auto = function (e) {
                if (e.clipboardData) {
                    var items = e.clipboardData.items;
                    if (!items) return;

                    //access data directly
                    var is_image = false;
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            //image
                            var blob = items[i].getAsFile();
                            var URLObj = window.URL || window.webkitURL;
                            var source = URLObj.createObjectURL(blob);
                            this.paste_createImage(source);
                            is_image = true;
                        }
                    }
                    if (is_image == true) {
                        e.preventDefault();
                    }
                }
            };
            //draw pasted image to canvas
            this.paste_createImage = function (source) {
                var pastedImage = new Image();
                pastedImage.src = source;
                pastedImage.onload = function () {
                    drawImageToCanvas(ctx, pastedImage);
                    process(ctx);
                };
            };
        }

    </script>



</body>

</html>